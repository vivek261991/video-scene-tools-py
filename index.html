<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Video Frame Matching</title>
</head>
<body>
  <h2>ðŸŽ¬ Frame RGB Grid Matching</h2>

  <!-- Video Player -->
  <video id="video" width="640" controls>
    <source src="clip.mp4" type="video/mp4" />
    Your browser does not support the video tag.
  </video>

  <br><br>
  <button onclick="captureFrameAndSend()">ðŸ“¸ Capture Frame</button>

  <script>
    function downsampleTo5x5(imageData) {
      const { data, width, height } = imageData;
      const stepX = Math.floor(width / 5);
      const stepY = Math.floor(height / 5);
      const result = {};

      for (let y = 0; y < 5; y++) {
        for (let x = 0; x < 5; x++) {
          let r = 0, g = 0, b = 0, count = 0;

          for (let dy = 0; dy < stepY; dy++) {
            for (let dx = 0; dx < stepX; dx++) {
              const px = (y * stepY + dy) * width + (x * stepX + dx);
              r += data[px * 4];
              g += data[px * 4 + 1];
              b += data[px * 4 + 2];
              count++;
            }
          }

          const key = `${x},${y}`;
          result[key] = [
            Math.round(r / count),
            Math.round(g / count),
            Math.round(b / count)
          ];
        }
      }

      return result;
    }

    function captureFrameAndSend() {
      const video = document.getElementById("video");
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const rgbGrid = downsampleTo5x5(imageData);

      fetch("/api/search/frame", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ rgb_grid: rgbGrid })
      })
        .then(res => res.json())
        .then(data => {
          console.log("Frame Match Result:", data);
          alert("Identified Movie: " + data.movie_name);
        })
        .catch(err => console.error("Error:", err));
    }
  </script>
</body>
</html>
